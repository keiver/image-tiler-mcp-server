name: Test PR

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 22]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - run: npm ci
      - run: npm test
      - run: npm run build

  validate-version-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check version labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            const versionLabels = labels.filter(l =>
              ['version:patch', 'version:minor', 'version:major'].includes(l)
            );

            if (versionLabels.length > 1) {
              core.setFailed(
                `PR has multiple version labels: ${versionLabels.join(', ')}. Use at most one.`
              );
            } else if (versionLabels.length === 0) {
              core.notice('No version label found. Merging this PR will not trigger a release.');
            } else {
              core.info(`Version label: ${versionLabels[0]}`);
            }
